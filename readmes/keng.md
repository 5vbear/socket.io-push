手机推送系统中的坑和解决方法

##IOS APNS推送

APNS推送, 需要自己保存ios上报的token, APNS本身不提供全网推送接口, 如果要做一次全网推送, 需要从数据库中查出所有token, 逐个推送. 对于一个用户量较高的APP, 需要存储的token数, 可能在百万或者千万级. 

1. **国内到APNS服务器网络问题**

  我们项目中, 从国内某机房, 做一次6w的批量推送, 需要10~15分钟. 增加到APNS的连接数, 也无法提升速度.
  
  **解决方法:** 之后把APNS调用服务部署到了香港机房, 同样一次6w的批量推送, 10秒左右就完成了, 速度提升近100倍. 可见国内某些机房到APNS服务器, 网络有很大问题.
  
2. **token相关**
  
  1. 用户如果不允许通知权限, 是无法获取token的. 用户卸载APP, 或者禁用通知, 一般来说APP也无法得知.
  2. 根据IOS版本的不同, 卸载重装APP, token可能变, 也可能不变. 用户升级/重装操作系统, 也可能会变. 所以每次启动APP, 都需要重新上报token.
  3. 调用APNS推送, 对于已经卸载APP或者禁用通知的用户, APNS是不会有特殊返回值的.
  
3. **APNS调用报错: invalid token (8)**

  token非法, 最常见的产生原因 : ios开发, 测试, 企业版内测, 提交APPSTORE都有不同的bundleId, 而每个bundleId都对应不同的推送证书, 如果token存储的时候没有区分bundleId, 调用时就会产生错误8. 错误8太多, APNS有可能会断掉推送的http2长连接, 导致推送**失败率增加**.
  
  **解决方法:** 记录每个token对应的bundleId. 可以做到无论任bundleId的版本, 连正式/测试, 都可以收到APNS推送.
  
4. **发送用户看不到的通知**

  如果调用APNS的时候, 不传alert等, 只传payload, 这种推送, 用户是看不到的, 但APP内会收到回调.
  
  可以用于测试全网推送速度, 我们全网推送速度优化, 就是用这种方法来测试的.
  
